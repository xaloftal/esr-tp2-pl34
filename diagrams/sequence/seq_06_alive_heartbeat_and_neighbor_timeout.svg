<svg xmlns="http://www.w3.org/2000/svg" width="1100" height="500" viewBox="20 40 1100 750" preserveAspectRatio="xMidYMid meet">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#1f6feb"/>
    </marker>
    <style>
      .title { font: 700 18px sans-serif; fill: #1f6feb; }
      .label { font: 14px sans-serif; fill: #111; }
      .small { font: 12px sans-serif; fill: #111; }
      .box { fill: #f2f8ff; stroke: #1f6feb; stroke-width: 1.6; }
      .life { stroke: #94a3b8; stroke-width: 1.2; stroke-dasharray: 6 6; }
      .msg { stroke: #1f6feb; stroke-width: 1.6; marker-end: url(#arrow); }
      .note { fill: #ffffff; stroke: #94a3b8; stroke-width: 1.2; }
      .sep { stroke: #eb5757; stroke-width: 1.2; stroke-dasharray: 2 6; }
    </style>
  </defs>

  <!-- Participants -->
  <rect x="60"  y="60" width="260" height="44" class="box"/>
  <text x="80"  y="88" class="label">Nó A (monitorização)</text>

  <rect x="430" y="60" width="260" height="44" class="box"/>
  <text x="450" y="88" class="label">Nó vizinho B</text>

  <rect x="800" y="60" width="260" height="44" class="box"/>
  <text x="820" y="88" class="label">Limpeza local / rotas</text>

  <!-- Lifelines -->
  <line x1="190" y1="104" x2="190" y2="670" class="life"/>
  <line x1="560" y1="104" x2="560" y2="670" class="life"/>
  <line x1="930" y1="104" x2="930" y2="670" class="life"/>

  <!-- Heartbeat loop -->
  <rect x="60" y="125" width="630" height="78" class="note"/>
  <text x="80" y="152" class="label">Ciclo periódico (a cada HEARTBEAT_INTERVAL)</text>
  <text x="80" y="174" class="small">O Nó A envia ALIVE apenas para vizinhos marcados como ativos em neighbors[ip]=True.</text>

  <line x1="190" y1="240" x2="560" y2="240" class="msg"/>
  <text x="275" y="230" class="label">ALIVE (TCP)</text>
  <text x="275" y="255" class="small">type=ALIVE, payload={}</text>

  <line x1="560" y1="290" x2="190" y2="290" class="msg"/>
  <text x="285" y="280" class="label">ALIVE (TCP)</text>
  <text x="285" y="305" class="small">type=ALIVE (recebido no Nó A)</text>

  <rect x="90" y="320" width="520" height="88" class="note"/>
  <text x="110" y="346" class="label">Ao receber ALIVE no Nó A</text>
  <text x="110" y="368" class="small">last_alive[B] = now; fail_count[B] = 0</text>
  <text x="110" y="388" class="small">neighbors[B] mantém-se ativo</text>

  <line x1="40" y1="430" x2="1060" y2="430" class="sep"/>
  <text x="40" y="456" class="label">Caso de falha (sem ALIVE recebido)</text>

  <rect x="60" y="470" width="720" height="104" class="note"/>
  <text x="80" y="496" class="label">Contabilização de timeouts (no ciclo heartbeat)</text>
  <text x="80" y="518" class="small">Se now - last_alive[B] &gt; FAIL_TIMEOUT → fail_count[B]++</text>
  <text x="80" y="538" class="small">Se fail_count[B] ≥ MAX_FAILS → considerar B morto</text>

  <line x1="190" y1="600" x2="930" y2="600" class="msg"/>
  <text x="380" y="590" class="label">local_leave_cleanup(B)</text>
  <text x="380" y="615" class="small">marca neighbors[B]=False; desativa rotas que usam next_hop=B</text>

  <rect x="800" y="625" width="290" height="58" class="note"/>
  <text x="810" y="652" class="small">Se uma rota ativa morrer e houver clientes,</text>
   <text x="810" y="666" class="small">  o nó tenta failover via find_best_active_neighbour().</text>
</svg>
